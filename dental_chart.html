<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Chart - ShifoCRM</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981', // Emerald 500
                        secondary: '#059669', // Emerald 600
                        accent: '#3B82F6', // Blue 500
                        gray: {
                            50: '#F9FAFB',
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            800: '#1F2937',
                            900: '#111827',
                        }
                    },
                    borderRadius: {
                        'none': '0px', 'sm': '4px', DEFAULT: '8px',
                        'md': '12px', 'lg': '16px', 'xl': '24px',
                        '2xl': '32px', '3xl': '40px', 'full': '9999px',
                    },
                    boxShadow: {
                        'custom': '0 4px 12px rgba(0, 0, 0, 0.08)',
                        'lg': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Sidebar uchun responsiv stil */
        #sidebar {
            transition: transform 0.3s ease-out;
            transform: translateX(-100%);
            position: fixed;
        }

        #sidebar.active {
            transform: translateX(0);
        }

        @media (min-width: 1024px) {
            #sidebar {
                transform: translateX(0);
                position: relative;
            }
        }

        .modal-bg {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex">
    <aside id="sidebar"
        class="w-64 bg-white shadow-2xl flex flex-col h-screen fixed lg:relative z-40">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-md">
                <i class="ri-hospital-line text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg">ShifoCRM</h1>
                <span
                    class="text-xs bg-gradient-to-r from-red-500 to-orange-400 text-white px-2 py-0.5 rounded-full">DEMO</span>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <a href="./patients.html"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                <i class="ri-user-heart-line"></i> <span>Bemorlar ro'yxati</span>
            </a>
            <a href="./dental_chart.html"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold bg-primary text-white shadow-md">
                <i class="ri-tooth-line"></i> <span>Dental Chart</span>
            </a>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                <i class="ri-calendar-check-line"></i><span>Yangi qabul</span>
            </a>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                <i class="ri-calendar-line"></i><span>Kalendar</span>
            </a>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                <i class="ri-notification-line"></i><span>Eslatmalar</span>
            </a>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                <i class="ri-bar-chart-line"></i><span>Statistika</span>
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <a href="./register.html"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-red-600 hover:bg-red-50">
                <i class="ri-logout-box-line"></i> Demo rejimdan chiqish
            </a>
        </div>
    </aside>


    <div class="flex-1 flex flex-col">
        <header
            class="bg-white p-4 flex justify-between items-center border-b border-gray-100 sticky top-0 z-10 shadow-sm">
            <button id="openSidebar" class="lg:hidden text-gray-600 hover:text-primary transition">
                <i class="ri-menu-line text-2xl"></i>
            </button>
            <h1 class="text-xl font-bold flex items-center gap-2 text-gray-800 ml-3 lg:ml-0">
                <i class="ri-tooth-line text-2xl text-primary"></i> Dental Chart
            </h1>

            <a href="./profil.html" class="ml-auto">
                <div
                    class="flex items-center gap-2 bg-gray-100 border border-gray-200 px-3 py-1 rounded-xl shadow-sm hover:bg-gray-200 transition">
                    <div id="profileAvatar"
                        class="w-9 h-9 bg-primary rounded-full text-white flex items-center justify-center font-bold text-sm">D</div>
                    <span id="profileName" class="font-medium text-gray-800 hidden sm:block">---</span>
                </div>
            </a>
        </header>

        <main class="p-4 md:p-8">
            <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-2xl p-6 mb-8 border border-gray-100">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-800">
                    <i class="ri-search-line text-primary"></i> Bemorni qidirish
                </h2>
                <div class="relative">
                    <input type="text" id="patientSearch" placeholder="Ism yoki familiya kiriting..."
                        class="w-full border border-gray-300 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary focus:border-primary outline-none transition shadow-sm" />
                    <ul id="searchResults"
                        class="absolute z-20 bg-white border border-gray-200 w-full rounded-xl mt-1 shadow-xl hidden max-h-60 overflow-y-auto text-sm">
                    </ul>
                </div>
            </div>

            <div id="chartContainer" class="hidden max-w-4xl mx-auto">
                
                <div id="patientCard"
                    class="bg-gradient-to-r from-primary to-secondary text-white shadow-2xl rounded-2xl p-6 mb-8 transform transition duration-500 hover:scale-[1.01]">
                    <!-- Patient details here -->
                </div>

                <!-- DENTAL CHART SECTION -->
                <div class="bg-white shadow-lg rounded-2xl p-6 sm:p-8 border border-gray-100">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-3">
                        <i class="ri-tooth-line text-primary text-2xl"></i> Tishlar jadvali (Dental Chart)
                    </h2>

                    <div class="grid grid-cols-16 text-center overflow-x-auto pb-4">
                        <div class="min-w-[500px] flex justify-between space-x-2">
                             <div id="upperJawRight" class="flex-1 flex justify-end gap-2 text-center text-xs"></div>
                             <div id="upperJawLeft" class="flex-1 flex justify-start gap-2 text-center text-xs"></div>
                        </div>
                    </div>
                    
                    <div class="border-t-4 border-dashed border-gray-200 my-6 max-w-lg mx-auto"></div>
                    
                    <div class="grid grid-cols-16 text-center overflow-x-auto pt-4">
                        <div class="min-w-[500px] flex justify-between space-x-2">
                             <div id="lowerJawRight" class="flex-1 flex justify-end gap-2 text-center text-xs"></div>
                             <div id="lowerJawLeft" class="flex-1 flex justify-start gap-2 text-center text-xs"></div>
                        </div>
                    </div>


                    <div class="mt-8 flex flex-wrap gap-x-6 gap-y-4 text-sm justify-center sm:justify-start pt-6 border-t border-gray-100">
                        <span class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-lg bg-primary shadow-sm"></div> Sog‚Äòlom
                        </span>
                        <span class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-lg bg-yellow-500 shadow-sm"></div> Kariyes
                        </span>
                        <span class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-lg bg-blue-500 shadow-sm"></div> Plomba
                        </span>
                        <span class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-lg bg-red-500 shadow-sm"></div> Olib tashlangan
                        </span>
                    </div>

                    
                </div>
                <!-- END DENTAL CHART SECTION -->

                <!-- SERVICES AND TREATMENT PLAN SECTION -->
                <div class="bg-white shadow-lg rounded-2xl p-6 sm:p-8 border border-gray-100 mt-8">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-3">
                        <i class="ri-money-dollar-circle-line text-accent text-2xl"></i> Xizmatlar va Davolash Rejasi
                    </h2>

                    <!-- Add Service Form -->
                    <div class="mb-6 p-4 border border-blue-100 bg-blue-50 rounded-xl">
                        <div class="md:flex gap-4 items-end">
                            <div class="flex-1 mb-4 md:mb-0">
                                <label for="serviceSelect" class="block mb-2 text-sm font-medium text-gray-700">Xizmat turi:</label>
                                <select id="serviceSelect" class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-accent focus:border-accent outline-none text-sm"></select>
                            </div>
                            <div class="mb-4 md:mb-0">
                                <label for="serviceQuantity" class="block mb-2 text-sm font-medium text-gray-700">Soni:</label>
                                <input type="number" id="serviceQuantity" value="1" min="1"
                                    class="w-20 border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-accent focus:border-accent outline-none text-sm text-center">
                            </div>
                            <button id="addServiceBtn"
                                class="w-full md:w-auto px-5 py-2.5 bg-accent text-white rounded-xl shadow-md hover:bg-blue-600 font-medium transition flex items-center justify-center gap-2">
                                <i class="ri-add-line"></i> Qo'shish
                            </button>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Xizmat nomi</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Soni</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Narxi</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Jami</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="p-4 text-center text-gray-500 italic">Davolash rejasiga xizmatlar qo'shilmagan.</td></tr>
                            </tbody>
                            <tfoot class="bg-gray-50 border-t-2 border-primary">
                                <tr>
                                    <td colspan="4" class="px-4 py-3 text-right text-lg font-bold text-gray-800">Jami xizmatlar narxi:</td>
                                    <td id="totalCost" class="px-4 py-3 text-right text-lg font-bold text-primary">0 UZS</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <!-- END SERVICES SECTION -->

                <div class="mt-8 flex justify-end">
                    <button id="saveChartBtn"
                        class="px-6 py-3 bg-primary text-white rounded-xl shadow-lg hover:bg-secondary hover:scale-[1.02] transform transition font-medium flex items-center gap-2">
                        <i class="ri-save-line"></i> Saqlash
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="toothModal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50 p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 id="modalToothNumber" class="text-xl font-bold mb-4 text-primary flex items-center gap-2">
                <i class="ri-edit-line"></i> Tish #
            </h3>
            <label class="block mb-2 text-sm font-medium text-gray-700">Status:</label>
            <select id="toothStatus"
                class="w-full border border-gray-300 rounded-xl px-4 py-2.5 mb-4 focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none text-sm">
                <option value="healthy">Sog‚Äòlom</option>
                <option value="cariyes">Kariyes</option>
                <option value="filled">Plomba</option>
                <option value="missing">Olib tashlangan</option>
            </select>
            <label class="block mb-2 text-sm font-medium text-gray-700">Izoh:</label>
            <textarea id="toothNote" rows="3" placeholder="Izoh..."
                class="w-full border border-gray-300 rounded-xl px-4 py-2.5 mb-6 focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none text-sm"></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()"
                    class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-xl font-medium transition">Bekor</button>
                <button id="saveToothBtn"
                    class="px-5 py-2.5 bg-primary text-white hover:bg-secondary rounded-xl font-medium shadow-md transition">Saqlash</button>
            </div>
        </div>
    </div>

    <script>
        const API_PATIENTS = "https://shifo-crm-7.onrender.com/patients";
        const API_CHARTS = "https://shifo-crm-7.onrender.com/dentalCharts";

        // Hardcoded Service Data (UZS - O'zbekiston So'mi)
        const DENTAL_SERVICES = [
            { id: "S1", name: "Tishni tozalash (professional)", price: 350000 },
            { id: "S2", name: "Oddiy plomba qo'yish", price: 200000 },
            { id: "S3", name: "Kompleks plomba (uch yuzali)", price: 450000 },
            { id: "S4", name: "Tishni olib tashlash (oddiy)", price: 150000 },
            { id: "S5", name: "Murakkab olib tashlash", price: 400000 },
            { id: "S6", name: "Kanalni davolash (Endodontiya)", price: 600000 },
            { id: "S7", name: "Koronka qo'yish (Metal-keramika)", price: 1200000 },
            { id: "S8", name: "Ortodontik konsultatsiya", price: 50000 },
        ];


        const sidebar = document.getElementById("sidebar");
        const openSidebar = document.getElementById("openSidebar");
        const searchInput = document.getElementById("patientSearch");
        const searchResults = document.getElementById("searchResults");
        const chartContainer = document.getElementById("chartContainer");
        const patientCard = document.getElementById("patientCard");
        const upperJawRight = document.getElementById("upperJawRight");
        const upperJawLeft = document.getElementById("upperJawLeft");
        const lowerJawRight = document.getElementById("lowerJawRight");
        const lowerJawLeft = document.getElementById("lowerJawLeft");
        
        const saveChartBtn = document.getElementById("saveChartBtn");
        const toothModal = document.getElementById("toothModal");
        const modalToothNumber = document.getElementById("modalToothNumber");
        const toothStatus = document.getElementById("toothStatus");
        const toothNote = document.getElementById("toothNote");
        const saveToothBtn = document.getElementById("saveToothBtn");
        const profileNameEl = document.getElementById("profileName");
        const profileAvatarEl = document.getElementById("profileAvatar");
        const mainContainer = document.querySelector("main"); // Message uchun asosiy container

        // New DOM elements for services
        const serviceSelect = document.getElementById("serviceSelect");
        const serviceQuantity = document.getElementById("serviceQuantity");
        const addServiceBtn = document.getElementById("addServiceBtn");
        const servicesTableBody = document.getElementById("servicesTableBody");
        const totalCostEl = document.getElementById("totalCost");


        let doctor = JSON.parse(localStorage.getItem("doctor"));
        if (!doctor) window.location.href = "register.html";

        let patientsData = [];
        let currentPatient = null;
        let currentTeeth = [];
        let currentServices = []; // Yangi holat
        let selectedTooth = null;


        // === Asosiy yordamchi funksiyalar ===

        // Xabar chiqarish (alert() o'rniga)
        function showMessage(message, type = 'success') {
            const container = document.createElement('div');
            container.className = `fixed top-4 right-4 z-50 p-4 rounded-xl shadow-2xl text-white font-medium transition-all transform duration-300 ${type === 'success' ? 'bg-primary' : 'bg-red-500'}`;
            container.textContent = message;
            mainContainer.appendChild(container);

            setTimeout(() => {
                container.classList.add('opacity-0', 'translate-x-full');
                container.addEventListener('transitionend', () => container.remove());
            }, 3000);
        }

        // Valyuta formatlash
        function formatCurrency(amount) {
            return new Intl.NumberFormat('uz-UZ', { style: 'currency', currency: 'UZS', maximumFractionDigits: 0 }).format(amount).replace(/\sUZS/g, '');
        }

        // === Init Profil ===
        profileNameEl.textContent = doctor.fullname;
        profileAvatarEl.textContent = doctor.fullname.charAt(0).toUpperCase();

        // === Sidebar toggle ===
        openSidebar?.addEventListener("click", () => sidebar.classList.toggle("active"));

        // === Bemorlarni olish ===
        async function loadPatients() {
            const res = await fetch(API_PATIENTS);
            const all = await res.json();
            patientsData = all.filter(p => String(p.doctorId) === String(doctor.id));
        }

        // === Search ===
        searchInput.addEventListener("input", () => {
            const query = searchInput.value.toLowerCase();
            searchResults.innerHTML = "";

            if (!query) {
                searchResults.classList.add("hidden");
                return;
            }

            const filtered = patientsData.filter(p => (p.name || "").toLowerCase().includes(query));
            if (filtered.length === 0) {
                searchResults.innerHTML = `<li class="px-4 py-2 text-gray-500">Topilmadi</li>`;
            } else {
                filtered.forEach(patient => {
                    const li = document.createElement("li");
                    li.className = "px-4 py-3 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0";
                    li.innerText = patient.name;
                    li.onclick = () => selectPatient(patient);
                    searchResults.appendChild(li);
                });
            }
            searchResults.classList.remove("hidden");
        });
        
        // Bemorni tanlash uchun qidiruv joyidan tashqariga bosilganda yopish
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add("hidden");
            }
        });


        // === Bemor tanlash ===
        function selectPatient(patient) {
            currentPatient = patient;
            searchInput.value = patient.name;
            searchResults.classList.add("hidden");

            patientCard.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${patient.name}</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <p><i class="ri-cake-line mr-1"></i> <span class="font-medium">Yosh:</span> ${patient.age || "‚Äî"}</p>
                    <p><i class="ri-phone-line mr-1"></i> <span class="font-medium">Telefon:</span> ${patient.phone || "‚Äî"}</p>
                    <p><i class="ri-calendar-check-line mr-1"></i> <span class="font-medium">Oxirgi tashrif:</span> ${patient.lastVisit || "‚Äî"}</p>
                    <p><i class="ri-user-star-line mr-1"></i> <span class="font-medium">Status:</span> ${patient.status || "‚Äî"}</p>
                </div>
            `;

            chartContainer.classList.remove("hidden");
            loadDentalChart(patient.id);
        }

        // === Dental chart va services yuklash ===
        async function loadDentalChart(patientId) {
            const res = await fetch(`${API_CHARTS}?patientId=${patientId}&doctorId=${doctor.id}`);
            const data = await res.json();
            currentTeeth = data[0]?.teeth || [];
            currentServices = data[0]?.services || []; // Xizmatlarni yuklash
            renderTeeth();
            renderServices(); // Xizmatlarni render qilish
        }

        // === Tish statusi bo'yicha rangni belgilash ===
        function getStatusClass(status) {
            switch (status) {
                case "cariyes": return "bg-yellow-500 text-gray-800 shadow-md";
                case "filled": return "bg-blue-500 text-white shadow-md";
                case "missing": return "bg-red-500 text-white shadow-md";
                default: return "bg-primary text-white shadow-md";
            }
        }

        // === Tishlarni render qilish ===
        function renderTeeth() {
            upperJawRight.innerHTML = "";
            upperJawLeft.innerHTML = "";
            lowerJawRight.innerHTML = "";
            lowerJawLeft.innerHTML = "";
            
            // Tish raqamlarini to'g'ri tartibda hosil qilish (18-11, 21-28, 48-41, 31-38)
            const upperTeethOrder = [18, 17, 16, 15, 14, 13, 12, 11, 21, 22, 23, 24, 25, 26, 27, 28];
            const lowerTeethOrder = [48, 47, 46, 45, 44, 43, 42, 41, 31, 32, 33, 34, 35, 36, 37, 38];

            upperTeethOrder.forEach(i => createToothElement(i, i >= 11 && i <= 18 ? upperJawRight : upperJawLeft));
            lowerTeethOrder.forEach(i => createToothElement(i, i >= 41 && i <= 48 ? lowerJawRight : lowerJawLeft));

            function createToothElement(i, parent) {
                const tooth = currentTeeth.find(t => Number(t.id) === i);
                const div = document.createElement("div");
                div.className = `w-8 h-8 md:w-10 md:h-10 flex flex-col items-center justify-center text-xs rounded-lg cursor-pointer font-bold border border-gray-200 transition hover:scale-105 ${tooth ? getStatusClass(tooth.status) : "bg-primary text-white"}`;
                div.innerHTML = `<span class="text-[10px] text-gray-200">${Math.floor(i / 10)}</span><span class="text-sm">${i % 10}</span>`;
                div.onclick = () => openModal(i, tooth);
                parent.appendChild(div);
            }
        }

        // === Services functions ===
        function renderServices() {
            servicesTableBody.innerHTML = '';
            let total = 0;

            if (currentServices.length === 0) {
                servicesTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500 italic">Davolash rejasiga xizmatlar qo'shilmagan.</td></tr>`;
            }

            currentServices.forEach((service, index) => {
                const serviceData = DENTAL_SERVICES.find(s => s.id === service.serviceId);
                if (!serviceData) return;

                const subtotal = serviceData.price * service.quantity;
                total += subtotal;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-500">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${serviceData.name}</td>
                    <td class="px-4 py-3 text-center text-sm text-gray-700">${service.quantity}</td>
                    <td class="px-4 py-3 text-right text-sm text-gray-700">${formatCurrency(serviceData.price)} UZS</td>
                    <td class="px-4 py-3 text-right text-sm font-semibold text-gray-800">${formatCurrency(subtotal)} UZS</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="removeService(${index})" class="text-red-500 hover:text-red-700 transition">
                            <i class="ri-delete-bin-line text-lg"></i>
                        </button>
                    </td>
                `;
                servicesTableBody.appendChild(row);
            });

            totalCostEl.textContent = `${formatCurrency(total)} UZS`;
        }

        function addService() {
            const serviceId = serviceSelect.value;
            const quantity = parseInt(serviceQuantity.value);

            if (!currentPatient) {
                return showMessage("‚ùå Iltimos, avval bemorni tanlang.", "error");
            }
            if (!serviceId) {
                return showMessage("‚ùå Xizmat turini tanlang.", "error");
            }
            if (quantity < 1 || isNaN(quantity)) {
                return showMessage("‚ùå Miqdor 1 dan kam bo'lishi mumkin emas.", "error");
            }

            // Check if the service already exists and update quantity
            const existing = currentServices.find(s => s.serviceId === serviceId);

            if (existing) {
                existing.quantity += quantity;
            } else {
                currentServices.push({ serviceId, quantity });
            }
            
            // Reset inputs
            serviceQuantity.value = 1;

            renderServices();
            showMessage("‚úÖ Xizmat davolash rejasiga qo'shildi.");
        }
        
        function removeService(index) {
            if (index >= 0 && index < currentServices.length) {
                currentServices.splice(index, 1);
                renderServices();
                showMessage("üóëÔ∏è Xizmat davolash rejasidan olib tashlandi.");
            }
        }
        window.removeService = removeService; // Globalga ochish

        // Xizmatlarni dropdownga yuklash
        function populateServiceSelect() {
            serviceSelect.innerHTML = DENTAL_SERVICES.map(s => 
                `<option value="${s.id}">${s.name} (${formatCurrency(s.price)} UZS)</option>`
            ).join('');
        }
        addServiceBtn.addEventListener('click', addService);


        // === Modal boshqaruvi ===
        function openModal(toothNumber, toothData) {
            selectedTooth = toothNumber;
            modalToothNumber.innerHTML = `<i class="ri-edit-line"></i> Tish #${toothNumber}`;
            toothStatus.value = toothData ? toothData.status : "healthy";
            toothNote.value = toothData ? toothData.note : "";
            toothModal.classList.remove("hidden");
            toothModal.classList.add("flex");
        }
        function closeModal() { toothModal.classList.add("hidden"); }
        window.closeModal = closeModal;

        saveToothBtn.onclick = () => {
            const status = toothStatus.value;
            const note = toothNote.value;
            const existing = currentTeeth.find(t => Number(t.id) === selectedTooth);
            
            const newToothData = { id: String(selectedTooth), status, note };
            
            if (existing) {
                // Yangilash
                Object.assign(existing, newToothData);
            } else {
                // Qo'shish
                currentTeeth.push(newToothData);
            }
            
            // Agar status 'healthy' va note bo'sh bo'lsa, ro'yxatdan o'chirish
            if (status === 'healthy' && !note.trim()) {
                currentTeeth = currentTeeth.filter(t => Number(t.id) !== selectedTooth);
            }

            closeModal();
            renderTeeth();
        };

        // === Saqlash ===
        saveChartBtn.onclick = async () => {
            if (!currentPatient) return showMessage("‚ùå Iltimos, bemorni tanlang.", "error");
            
            // Faqat o'zgartirilgan (sog'lom bo'lmagan yoki notga ega bo'lgan) tishlarni saqlaymiz
            const teethToSave = currentTeeth.filter(t => t.status !== 'healthy' || t.note.trim());
            
            const payload = {
                patientId: currentPatient.id,
                doctorId: doctor.id,
                visitDate: new Date().toISOString().split("T")[0],
                teeth: teethToSave,
                services: currentServices // Xizmatlarni payloadga qo'shish
            };
            
            const res = await fetch(`${API_CHARTS}?patientId=${currentPatient.id}&doctorId=${doctor.id}`);
            const data = await res.json();
            
            try {
                if (data.length > 0) {
                    // Update
                    await fetch(`${API_CHARTS}/${data[0].id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ ...data[0], ...payload })
                    });
                } else {
                    // New entry
                    await fetch(API_CHARTS, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id: "dc" + Date.now(), ...payload })
                    });
                }
                showMessage("‚úÖ Dental chart va davolash rejasidagi o'zgarishlar muvaffaqiyatli saqlandi.");
            } catch (error) {
                console.error("Saqlashda xatolik:", error);
                showMessage("‚ùå Saqlashda xatolik yuz berdi.", "error");
            }
        };

        // === Init ===
        (async function init() { 
            await loadPatients(); 
            populateServiceSelect(); 
        })();
    </script>
</body>

</html>
