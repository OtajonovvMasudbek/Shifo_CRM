<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistika - ShifoCRM</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#16A34A',
                        secondary: '#14853A',
                        accent: '#3B82F6',
                        danger: '#EF4444',
                        gray: {
                            50: '#F9FAFB',
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                        }
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Umumiy stil va mobil sidebar uchun stil */
        .sidebar-overlay-visible {
            opacity: 1;
            visibility: visible;
        }

        /* Chart tooltip uchun stil */
        .chart-tooltip {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            position: absolute;
            z-index: 10;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 transition-opacity duration-300 opacity-0 invisible"
        onclick="closeSidebarFn()"></div>

    <aside id="sidebar"
        class="fixed top-0 left-0 w-64 h-full bg-white z-50 shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <div class="p-4 border-b">
            <h2 class="text-xl font-bold text-primary">ShifoCRM</h2>
        </div>
        <nav class="p-4 space-y-2">
            <a href="index.html"
                class="flex items-center gap-3 p-3 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                <i class="ri-dashboard-line"></i> Bosh sahifa
            </a>
            <a href="patients.html"
                class="flex items-center gap-3 p-3 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                <i class="ri-user-heart-line"></i> Bemorlar
            </a>
            <a href="calendar.html"
                class="flex items-center gap-3 p-3 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                <i class="ri-calendar-line"></i> Kalendar
            </a>
            <a href="dental_chart.html"
                class="flex items-center gap-3 p-3 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                <i class="ri-stethoscope-line"></i> Dental Chart
            </a>
            <a href="admission.html"
                class="flex items-center gap-3 p-3 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                <i class="ri-add-circle-line"></i> Onlayn Qabul
            </a>
            <a href="statistics.html" class="flex items-center gap-3 p-3 text-white bg-primary rounded-lg transition">
                <i class="ri-bar-chart-box-line"></i> Statistika
            </a>
        </nav>
        <div class="absolute bottom-0 w-full p-4 border-t">
            <button onclick="logout()"
                class="w-full text-left flex items-center gap-3 p-3 text-danger hover:bg-red-50 rounded-lg transition">
                <i class="ri-logout-box-line"></i> Chiqish
            </button>
        </div>
    </aside>

    <div class="lg:ml-64 p-4 lg:p-8">

        <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow mb-8">
            <button id="openSidebar" class="lg:hidden text-2xl text-primary"><i class="ri-menu-line"></i></button>
            <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-800">Statistika</h1>
            <div id="profileInfo" class="flex items-center gap-3">
                <span id="doctorName" class="font-semibold text-gray-700 text-sm sm:text-base">Shifokor</span>
                <img id="doctorAvatar" src="default_avatar.png" alt="Avatar"
                    class="w-10 h-10 rounded-full object-cover border-2 border-primary">
            </div>
        </header>

        <section id="stats-filters"
            class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col sm:flex-row gap-4 items-end">
            <div class="flex-grow w-full sm:w-auto">
                <label for="doctorFilter" class="block text-sm font-medium text-gray-700 mb-1">Shifokor bo'yicha</label>
                <select id="doctorFilter"
                    class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-primary focus:border-primary transition">
                    <option value="all">Barcha Shifokorlar</option>
                </select>
            </div>

            <div class="w-full sm:w-auto">
                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Boshlanish sanasi</label>
                <input type="date" id="startDate"
                    class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-primary focus:border-primary transition">
            </div>

            <div class="w-full sm:w-auto">
                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Tugash sanasi</label>
                <input type="date" id="endDate"
                    class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-primary focus:border-primary transition">
            </div>

            <button id="applyFiltersBtn" onclick="applyFilters()"
                class="w-full sm:w-auto px-6 py-2.5 rounded-lg bg-primary text-white font-semibold hover:bg-secondary transition shadow-md">
                <i class="ri-filter-line mr-2"></i> Filtrlash
            </button>
        </section>

        <section id="stats-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary">
                <p class="text-sm font-medium text-gray-500">Umumiy Bemorlar</p>
                <p id="totalPatients" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                <div class="text-sm text-gray-400 mt-2">Tanlangan davrda</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-accent">
                <p class="text-sm font-medium text-gray-500">Faol Bemorlar</p>
                <p id="activePatients" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                <div class="text-sm text-gray-400 mt-2">Davolanayotgan bemorlar</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-secondary">
                <p class="text-sm font-medium text-gray-500">Yangi Bemorlar</p>
                <p id="newPatients" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                <div class="text-sm text-gray-400 mt-2">Filtr bo'yicha qo'shilganlar</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-danger">
                <p class="text-sm font-medium text-gray-500">Yakunlangan Davolashlar</p>
                <p id="finishedTreatments" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                <div class="text-sm text-gray-400 mt-2">Filtr bo'yicha yakunlanganlar</div>
            </div>
        </section>

        <section id="stats-charts" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Oy bo'yicha Bemorlar (Yangi)</h3>
                <canvas id="monthlyPatientsChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Tish Muammolari Bo'yicha Statistika</h3>
                <canvas id="dentalStatusChart"></canvas>
            </div>
        </section>

    </div>

    <script>
        // API manzilini patients.js dagi singari belgilaymiz, faqat u global bo'lishi kerak.
        const API_BASE_URL = "http://localhost:5001";
        const API_PATIENTS = `${API_BASE_URL}/patients`;
        const API_CHARTS = `${API_BASE_URL}/dentalCharts`; // !!! TUZATILDI: /dentalCharts o'rniga /dental_charts
        const API_DOCTORS = `${API_BASE_URL}/doctors`;

        let allPatients = [];
        let allCharts = [];
        let allDoctors = [];
        let monthlyChartInstance = null;
        let dentalChartInstance = null;
        let loggedInDoctorId = null; // Kirilgan shifokor ID sini saqlash uchun

        // === UTILITY: localStorage'dan shifokor ID sini olish ===
        function getLoggedInDoctorId() {
            const doctorData = localStorage.getItem("doctor");
            if (doctorData) {
                const doctor = JSON.parse(doctorData);
                // Agar localstorageda ID bo'lsa, uni qaytaramiz
                return doctor.id || null;
            }
            return null;
        }

        // --- Sidebar Funksiyalari (o'zgarishsiz) ---
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function openSidebarFn() {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            sidebarOverlay.classList.add('sidebar-overlay-visible');
        }

        function closeSidebarFn() {
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.remove('sidebar-overlay-visible');
        }

        document.getElementById('openSidebar').addEventListener('click', openSidebarFn);
        window.closeSidebarFn = closeSidebarFn;

        // --- Shifokor ma'lumotini yuklash ---
        function renderDoctorInfo() {
            const doctor = JSON.parse(localStorage.getItem("doctor") || '{"name": "Admin", "avatar": "default_avatar.png"}');
            document.getElementById("doctorName").textContent = doctor.name;
            document.getElementById("doctorAvatar").src = doctor.avatar && doctor.avatar !== "default_avatar.png"
                ? doctor.avatar
                : "https://ui-avatars.com/api/?name=AD&background=16A34A&color=fff";
        }

        // --- Filtrlar funksiyasi ---

        // Filtrlar uchun boshlang'ich ma'lumotlarni yuklash
        async function loadDoctorsForFilter() {
            try {
                const doctorsRes = await fetch(API_DOCTORS);
                allDoctors = await doctorsRes.json();
            } catch (error) {
                console.warn("Doctors ma'lumotlari yuklanmadi. Shartli ma'lumotlar ishlatilmoqda.");
                allDoctors = [
                    { id: "d1", name: "Dr. Ali Valiyev" },
                    { id: "d2", name: "Dr. Nodira Salimova" }
                ];
            }

            const doctorFilterEl = document.getElementById('doctorFilter');
            allDoctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.id;
                option.textContent = doctor.name;
                doctorFilterEl.appendChild(option);
            });
        }

        // Asosiy ma'lumotlarni yuklash (Serverdan bir marta olinadi)
        async function loadAllData() {
            try {
                const patientsRes = await fetch(API_PATIENTS);
                allPatients = await patientsRes.json();

                const chartsRes = await fetch(API_CHARTS);
                allCharts = await chartsRes.json();

            } catch (error) {
                console.error("Ma'lumotlarni yuklashda xatolik yuz berdi:", error);
                document.getElementById('stats-cards').innerHTML = '<p class="text-danger">Statistikani yuklashda xatolik yuz berdi. Server ishlayotganiga ishonch hosil qiling.</p>';
                throw new Error("Data fetch error");
            }
        }


        // Filtrlarni qo'llash va statistikani qayta hisoblash
        window.applyFilters = function () {
            const doctorId = document.getElementById('doctorFilter').value;
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;

            const startDate = startDateStr ? new Date(startDateStr) : null;
            const endDate = endDateStr ? new Date(endDateStr) : null;

            // 1. Ma'lumotlarni filtrlash
            let filteredPatients = allPatients.filter(patient => {
                let match = true;

                // Shifokor bo'yicha filtrlash
                if (doctorId !== 'all' && patient.doctorId !== doctorId) {
                    match = false;
                }

                // Sana bo'yicha filtrlash
                if (patient.lastVisit) {
                    const visitDate = new Date(patient.lastVisit);
                    if (startDate && visitDate < startDate) {
                        match = false;
                    }
                    if (endDate) {
                        const adjustedEndDate = new Date(endDate);
                        adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
                        if (visitDate >= adjustedEndDate) {
                            match = false;
                        }
                    }
                }

                return match;
            });

            // 2. Filtrlar asosida Chart ma'lumotlarini filtrlash
            // ðŸš€ OPTIMALLASHTIRISH: Tezroq qidirish uchun Set ishlatildi (N-kvadratdan O(N) ga o'tish)
            const patientIdSet = new Set(filteredPatients.map(p => p.id));
            const filteredCharts = allCharts.filter(chart => patientIdSet.has(chart.patientId));

            // 3. Hisoblash va render qilish
            renderStatistics(filteredPatients, filteredCharts);
        }

        // --- Statistikani Render qilish (o'zgarishsiz) ---

        function renderStatistics(patients, charts) {
            const totalPatientsCount = patients.length;
            const activePatientsCount = patients.filter(p => p.status === 'Faol' || p.status === 'Kutilmoqda').length;
            const newPatientsCount = patients.filter(p => p.status === 'Kutilmoqda' || p.status === 'Faol').length;
            const finishedTreatmentsCount = charts.filter(c => c.teeth && c.teeth.some(t => t.status === 'filled' || t.status === 'crown' || t.status === 'root_canal')).length;

            document.getElementById('totalPatients').textContent = totalPatientsCount;
            document.getElementById('activePatients').textContent = activePatientsCount;
            document.getElementById('newPatients').textContent = newPatientsCount;
            document.getElementById('finishedTreatments').textContent = finishedTreatmentsCount;

            const monthlyData = generateMonthlyData(patients);
            renderMonthlyPatientsChart(monthlyData);

            const statusCounts = getDentalStatusCounts(charts);
            renderDentalStatusChart(statusCounts);
        }

        // --- Yordamchi Funksiyalar (getDentalStatusCounts, generateMonthlyData, Chart render funksiyalari o'zgarishsiz qoldi) ---

        function getDentalStatusCounts(charts) {
            const counts = {};
            const statuses = {
                'cariyes': 'Chiriq (Kariyes)', 'filled': 'Plombalangan', 'missing': 'Yo\'q', 'crown': 'Qoplama (Koronka)', 'root_canal': 'Ildiz Kanal', 'healthy': 'Sog\'lom'
            };

            charts.forEach(chart => {
                if (chart.teeth) {
                    chart.teeth.forEach(tooth => {
                        const statusKey = tooth.status;
                        if (statuses[statusKey]) {
                            counts[statuses[statusKey]] = (counts[statuses[statusKey]] || 0) + 1;
                        }
                    });
                }
            });

            return counts;
        }

        function generateMonthlyData(patients) {
            const monthCounts = {};
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setMonth(date.getMonth() - i);
                const monthYearKey = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
                monthCounts[monthYearKey] = { label: date.toLocaleString('uz', { month: 'short', year: '2-digit' }), count: 0, sortKey: monthYearKey };
            }

            patients.forEach(p => {
                if (p.lastVisit) {
                    const visitDate = new Date(p.lastVisit);
                    const monthYearKey = visitDate.getFullYear() + '-' + (visitDate.getMonth() + 1).toString().padStart(2, '0');
                    if (monthCounts[monthYearKey]) {
                        monthCounts[monthYearKey].count++;
                    }
                }
            });

            const sortedMonths = Object.values(monthCounts).sort((a, b) => (a.sortKey > b.sortKey) ? 1 : -1);

            return {
                labels: sortedMonths.map(m => m.label),
                data: sortedMonths.map(m => m.count)
            };
        }
        function renderMonthlyPatientsChart(data) {
            if (monthlyChartInstance) monthlyChartInstance.destroy();

            // Grafik balandligini to'g'rilash uchun yangi tanlov:
            // aspectRatio: 2 - Grafik eniga nisbatan 2:1 nisbatda bo'ladi (eni 2 barobar balandligidan katta)
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: true, // Auto heightni o'chiramiz, nisbatni o'zimiz beramiz
                aspectRatio: 1.8,         // Eng mos keladigan nisbatni tanlashingiz mumkin (Masalan, 1.8 yoki 2)
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            };

            monthlyChartInstance = new Chart(document.getElementById('monthlyPatientsChart'), {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Yangi/Tashrif Bemorlar',
                        data: data.data,
                        borderColor: '#16A34A',
                        backgroundColor: 'rgba(22, 163, 74, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: chartOptions
            });
        }
        function renderDentalStatusChart(counts) {
            if (dentalChartInstance) dentalChartInstance.destroy();
            const labels = Object.keys(counts);
            const data = Object.values(counts);
            const backgroundColors = [
                '#EF4444', '#3B82F6', '#9CA3AF', '#FBBF24', '#10B981', '#7C3AED'
            ];

            dentalChartInstance = new Chart(document.getElementById('dentalStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tish holatlari soni',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    
                    maintainAspectRatio: true,
                    aspectRatio: 1.5, 
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15 
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${context.parsed}`
                            }
                        }
                    }
                }
            });
        }
        // Sahifani ishga tushirish
        async function initialize() {
            loggedInDoctorId = getLoggedInDoctorId(); // Kirilgan shifokor ID sini olamiz
            renderDoctorInfo();
            await loadAllData();
            await loadDoctorsForFilter();

            // ðŸ”‘ Lokal ID bo'yicha filtrni standart qiymat qilib o'rnatish
            if (loggedInDoctorId && document.getElementById('doctorFilter').querySelector(`option[value="${loggedInDoctorId}"]`)) {
                document.getElementById('doctorFilter').value = loggedInDoctorId;
            }

            // O'rnatilgan filtrlar (yoki default filtr) bo'yicha statistikani yuklash
            applyFilters();
        }

        initialize();
    </script>

</body>

</html>